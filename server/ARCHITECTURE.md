# Server Architecture

The backend is built with **Go (Golang)** following **Clean Architecture** principles and the **Standard Go Project Layout**. It prioritizes modularity, testability, separation of concerns, and type safety.

## Tech Stack

- **Language**: Go 1.25+
- **Framework/Router**: [Chi](https://github.com/go-chi/chi) (v5) - Lightweight, idiomatic router.
- **Database**: MySQL (accessed via `database/sql` driver `go-sql-driver/mysql`).
- **ORM/Query Builder**: [sqlc](https://sqlc.dev/) - Generates type-safe Go code from SQL.
- **Authentication**: JWT (JSON Web Tokens) with `golang-jwt/jwt/v5`.
- **Configuration**: `godotenv` for `.env` management.
- **Utilities**:
  - **QR Code**: `yeqown/go-qrcode` for generation.
  - **Image Processing**: `fogleman/gg` & `golang.org/x/image` for resizing/manipulation.
  - **File Uploads**: Multipart handling with Go `net/http`, JPEG encoding via `image/jpeg`.
  - **Rate Limiting**: `httprate` middleware (IP-based).
  - **UUID**: `google/uuid`.

## Directory Structure

```
server/
├── cmd/
│   ├── api/
│   │   └── main.go           # Application Entry Point.
│   └── seed/
│       └── main.go           # Database Seeding Utility.
├── internal/
│   ├── api/                  # HTTP Transport Layer
│   │   ├── handler/          # HTTP Handlers
│   │   │   ├── auth.go
│   │   │   ├── blog.go
│   │   │   ├── image.go
│   │   │   ├── qr.go
│   │   │   └── url.go
│   │   ├── middleware/       # HTTP Middleware
│   │   ├── router.go         # Route definitions
│   │   └── server.go         # Server struct
│   ├── auth/                 # Authentication logic
│   │   └── auth.go
│   ├── config/               # Configuration Management
│   │   └── config.go
│   ├── database/             # Database Connection logic
│   │   └── database.go
│   ├── db/                   # Database Access Layer (Generated by sqlc)
│   │   ├── db.go
│   │   ├── models.go
│   │   └── query.sql.go
│   ├── service/              # Business Logic Layer
│   │   ├── blog_service.go
│   │   ├── image_service.go
│   │   ├── qr_service.go
│   │   └── url_service.go
│   └── utils/                # Shared Utilities
│       ├── image.go
│       ├── slug.go
│       └── validator.go
├── uploads/                  # Image Upload Storage
│   ├── original/             # Full-size images
│   ├── medium/               # 800px width
│   └── thumb/                # 300px width
├── api.exe                   # Compiled binary
├── schema.sql                # Database Schema
├── query.sql                 # SQL Queries for sqlc
├── sqlc.yaml                 # sqlc Configuration
├── go.mod                    # Go Module Dependencies
├── go.sum                    # Go Module Checksums
├── Taskfile.yml              # Task runner configuration
└── .env                      # Environment Variables
```

## Architecture Layers & Data Flow

Requests flow through the system in a unidirectional manner:

`HTTP Request` → **Router** → **Middleware** → **Handler** → **Service** → **Repository (DB)** → `Database`

### 1. HTTP Layer (`internal/api`)

- **Router (`router.go`)**: Defines URL patterns and applies middleware.
- **Middleware**: Intercepts requests for logging, panic recovery, rate limiting, and JWT authentication (`AdminOnlyMiddleware`).
- **Handlers (`internal/api/handler`)**:
  - Parse HTTP requests (JSON body, Path variables, Query params).
  - Validate input structure (e.g., required fields).
  - Invoke methods from the **Service Layer**.
  - Map Service results/errors to HTTP responses (JSON, Status Codes).
  - **Rule**: Handlers should _never_ contain complex business logic or SQL.

### 2. Service Layer (`internal/service`)

- **Core Business Logic**: Orchestrates data flow and applies business rules.
- **Responsibilities**:
  - Generates UUIDs, Slugs, and Timestamps.
  - Handles complex operations (e.g., "Create Post" = Create Post Row + Add Tags).
  - Calls the **Database Layer** for persistence.
  - Uses **Utils** for pure functions (e.g., `utils.MakeSlug`).
- **Rule**: Services are transport-agnostic (don't know about HTTP responses).

### 3. Database Layer (`internal/db`)

- **Generated Code**: Built by `sqlc` from `schema.sql` and `query.sql`.
- **Type-Safety**: Provides strictly typed methods for all SQL operations.
- **Responsibilities**:
  - Execute SQL queries.
  - Map SQL rows to Go structs.
  - Manage transactions (via `db.WithTx` pattern).
- **Rule**: No manual SQL string concatenation.

### 4. Configuration (`internal/config`)

- Centralized configuration loader.
- Reads from `.env` or system environment variables.
- Provides defaults for local development.

### 5. Utilities (`internal/utils`)

- Pure functions helpers.
- **Examples**: `MakeSlug(string)`, `ResizeImage(image, width)`, `ValidateURL(string)`.

## Image System

The image system provides CRUD operations for managing images with SEO support and performance optimization.

### Upload Pipeline

`Multipart Upload` → **Validate MIME** → **Decode** → **Resize (3 sizes)** → **JPEG Encode** → **Save to Disk** → **Insert DB**

### Image Sizes

| Size       | Width | Purpose             |
| ---------- | ----- | ------------------- |
| `thumb`    | 300px | Thumbnails, lists   |
| `medium`   | 800px | Blog content, cards |
| `original` | As-is | Full resolution     |

### SEO Fields

- `alt_text`: Descriptive text for screen readers and image search.
- `title`: Title attribute for hover tooltips.

### Performance

- **Cache-Control**: `public, max-age=31536000, immutable` (UUID filenames never change).
- **Direct File Serve**: `http.FileServer` for efficient static file serving.
- **JPEG Optimization**: Quality 80% for optimal size/quality ratio.

### Post Integration

Posts use `featured_image` (TEXT) to store an Image ID (UUID). The client resolves this to URLs via the Image API.

## Adding a New Feature

1.  **Database**: Add/Update schema in `schema.sql` and run `task sqlc` (if needing new tables/queries).
2.  **Service**: Create a new service or add method to existing service in `internal/service/` to handle the logic.
3.  **Handler**: Create a new handler in `internal/api/handler/` that calls the service.
4.  **Route**: Register the new handler in `internal/api/router.go`.
